## Data management
This section discusses three data management patterns that manage data on and o� blockchain.

## Encrypted On-Chain Data

Ensure confidentiality of the data stored on blockchain by encrypting it.

For some applications on blockchain, there might be commercially critical data that should be only
accessible to the involved participants. An example would be a special discount price o�ered by a service provider
to a subset of its users. Such information should not be accessible to the other users who do not get the discount.

**Problem:** Data privacy is one of the main limitations of blockchain. All the information on blockchain is publicly
available to the participants of the blockchain. There is no privileged user within the blockchain network, no
matter the blockchain is public, consortium or private. On a public blockchain, new participants can join the
blockchain network freely and access all the information recorded on blockchain.

**Solution:** To preserve the privacy of the involved participants, symmetric or asymmetric encryption can be used
to encrypt data before inserting the data into blockchain. One possible design for sharing encrypted data among
multiple participants is as follow. First, one of the involved participants creates a secret key for encrypting data
and distributes it during an initial key exchange. When one of the participants needs to add a new data item to
the blockchain, they first symmetrically encrypt it using the secret key. Only the participants allowed to access
the transaction have the secret key and can decrypt the information.

```solidity
// @TODO
```

## Tokenisation

Using tokens to represent fungible goods for easier distribution.

The concept of tokenisation has emerged centuries ago with the �rst currency systems. Tokenisation
is a means to reduce risk in handling high value �nancial instruments by replacing them with equivalents, for
example, the tokens used in casino. Tokens can represent a wide range of goods which are transferable and
fungible, like shares, or tickets.

**Problem:** Tokens representing assets should be the authoritative source of the corresponding assets.

**Solution:** Blockchain provides a trustworthy platform to realise tokenisation. There are di�erent ways to
implement tokenisation using blockchain. Naive tokens on a blockchain (e.g., BTC on Bitcoin, ETC on Ethereum)
can be used to formulate a system where the tokens represent monetary value or other physical assets. The token
is generally used to track title over the physical assets. Transactions on blockchain record the veri�able title
transfer from one user to another. However, using the native token on blockchain for tokenisation is limited
because it can only implement the title transfer of the physical assets, with limited conditions checking.
A more �exible way is to de�ne a data structure in a smart contract to represent physical assets. Tokenisation
is a process starting from an asset (e.g., money) is locked under a custody (e.g., a bank), and gets represented
in the cryptographic world through a token. The ownership of the digital token matches the ownership of the
corresponding asset. The reverse process can take place by which the user redeems the token to recover the value
which is sitting within the bank. A token on blockchain is the authoritative source of the physical asset. By using
smart contracts, some conditions can be implemented and associated with the ownership transfer.

```solidity
// TODO: Add NFT example
```
## Off-chain data storage

Use hashing to ensure the integrity of arbitrarily large datasets which may not �t directly on the
blockchain.

Some applications consider using the blockchain to guarantee the integrity of large amounts of data.

**Problem:** The blockchain, due to its full replication across all participants of the blockchain network, has limited
storage capacity. Storing large amounts of data within a transaction may be impossible due to the limited size of
the blocks of the blockchain (for example, Ethereum has a block gas limit to determine the number, computational
complexity, and data size of the transactions included in the block). Data cannot take advantage of the immutability
or integrity guarantees without being stored on the blockchain.

**Solution:** The blockchain can be used as a general-purpose replicated database, as transactions logged in the
blockchain can include arbitrary data on some blockchain platforms. For data of big size (essentially data that is
bigger than its hash value), rather than storing the raw data directly on blockchain, a representation of the data
with smaller size can be stored on blockchain with other small sized metadata about the data (e.g.a URI pointing
to it). The solution is to store a hash value (also called digest) of the raw data on chain. The value is generated by
a hash function, e.g.one from the SHA family, which maps data of arbitrary size to data of �xed size. Hash
function is a one-way function which is easy to compute, but hard to invert given the output of a random input.
If even one bit of the data changes, its corresponding hash value would change as well. The hash value is used
for ensuring the integrity of the raw data stored o�-chain, and the transaction on blockchain that includes the
hash value guarantees the integrity of the hash value as well as the original raw data from which the hash was
derived.

```solidity
pragma solidity ^0.5.6;

contract Hotel {
	constructor(address payable _manager, string memory _dataUri, address _index) public {
		require(bytes(_dataUri).length != 0);
		dataUri = _dataUri;
	}

	function _editInfoImpl(string memory _dataUri) internal {
		require(bytes(_dataUri).length != 0);
		require(bytes(_dataUri) != bytes(dataUri));
		dataUri = _dataUri;
	}
}
```

## State channel

Micro-payments transactions are too expensive to be performed on-chain because the required
transaction fee might be higher than the monetary value associated with the transaction assuming a public
blockchain is used. Thus, micro-payments should be exchanged o�-chain while periodically recording settlements
for larger amounts on chain. Such a payment channel can be generalized for arbitrary state updates.

Micro-payments are payments that can be as small as a few cents, e.g., payment of a very small amount
of money to a WiFi hot-spot for every 10 kilobytes of data usage. Blockchain has potential to be used for such
financial transactions with tiny monetary value. The question is if it is necessary and cost effective to store all
the micro-payment transactions on blockchain.

**Problem:** The decentralized design of blockchain has limited performance. Transactions can take several minutes
or even one hour (for Bitcoin blockchain) to be committed on the blockchain [17]. Due to the long commit time
and high transaction fees on a public blockchain (where fees are largely independent of the transacted amount), it
is often infeasible to store every micro-payment transaction on the blockchain network. During a recent peak in
demand, the average fee per transaction has risen to the equivalent of US$5526 on Bitcoin. On-chain transactions
are suitable for transactions with medium to large monetary value, relative to the transaction fee.

**Solution:** Storing every micro-payment transaction on blockchain is infeasible in certain contexts due to the small
monetary value associated with it. Thus, a solution is to establish a payment channel between two participants,
with a deposit from one or both sides of the participants locked up as security in a smart contract for the lifetime
of the payment channel. The payment channel keeps the intermediate states of the micro-payment o�-chain,
and only stores the �nalized payment on chain. The frequency of transaction settlement depends on the use
case, and agreement between the two sides. For example, in scenarios around utilities, internet service providers
or electricity companies can establish payment channel with their consumers for an agreed billing period, for
example, a month. As the consumer uses data or energy daily, the intermediate state is stored in the channel
until the end of the month, when the channel is closed to �nalize the payment of that month. A network of
micro-payment channels can be built where the transactions transferring small values occur off-chain. The individual transactions take place entirely out the blockchain and exclusively between the participants, across
multiple hops where needed. Only the final transaction that settles the payment for a given channel or set
of channels is submitted to the blockchain. The technologies used to implement state channel are speci�c to
blockchain platform. For example, Lightning network27 on the Bitcoin blockchain is a proposed implementation
of Hashed Timelock Contracts (HTLCs)28 with bi-directional payment channels which allows secure payments
across multiple peer-to-peer channels. A HTLC is a type of payments that use the features of Script, like hashlocks
and timelocks, to require that the receiver of a payment acknowledges receiving the payment prior to a deadline
by generating cryptographic proof. Fig. 8 is a graphical representation of the pattern. Such off-chain channels
could be generalized to exchange state for more general purposes other than monetary value.

